
# CMake for MDL-LLVM Integration

## Overview:

We’ve integrated the use of MDL into the CodeGen and MC libraries. The use of MDL is completely optional. To use MDL for a specific target or subtarget, you simply compose an MDL description and place it in the lib/Target/<target> directory, along with the target’s tablegen files.  CMake detects the file, and generates the makefile to compile and use the description.

There are no new libraries introduced by this integration.  We’ve added a few new source files to CodeGen, and we’re generating code which is included by existing CodeGen and MC source files (much like TableGen-generated files).

## Testing

Since no existing upstream targets use MDL, to test the integration of MDL with LLVM we’ve built tooling to automatically generate complete MDL descriptions for all targets that have Schedules and/or itineraries (AArch64, AMDGPU, R600, ARM, Hexagon, Lanai, Mips, PowerPC, RISCV Sparc, SystemZ, X86). This is controlled by a CMake command line parameter LLVM_ENABLE_MDL=1.

When enabled, the tooling scrapes each targets’ tablegen files and produces an equivalent MDL description.  The generated MDL description is then compiled and used as if it were a hand-written description.  Note that this is for testing purposes only.  The generated MDL produces a compiler that typically generates the exact same output code as the unmodified compiler.

## Integration Details:

We’ve added two new utilities to llvm that work with TableGen output files to produce code which is used in Codegen and MC libraries.  The two utilities are:

*   **utils/TdScan** - This scrapes architecture information from a target’s tablegen files
*   **utils/MdlCompiler** - a compiler for the MDL language that reads a .mdl file and produces C source code that is #included by Target and MC libraries.

We’ve written a CMake macro (makeMdlFiles, defined in llvm/cmake/modules/BuildMdl.cmake) that is called for each target. The macro looks for the existence of an MDL file in lib/Targets, and if found arranges to compile and use the MDL description. If a file is not found, it generates “empty” versions of the generated files.  When LLVM\_ENABLE\_MDL is specified on the cmake command line, it creates a makefile that generates and uses an MDL description from the target’s tablegen files (for testing purposes only!).

In the typical use case where we use a hand-written MDL description, we have the following new steps (in llvm/lib/Target/<target>/CMakeLists.txt, and in llvm/cmake/modules/BuildMdl.cmake):

1. We instruct TableGen to produce a “_TARGET_.txt” file, using the –print\_records flag.
2. We use tdscan to use the generated “TARGET.txt” to produce an MDL file that captures register, operand, and instruction information from tablegen, to be included in the target’s MDL file.
3. We use mdl to compile the _TARGET_.mdl” file into 3 “.inc” files which are included in Target and MC library source code (much like the output of tablegen.)
    1. _TARGET_GenMdlInfo.inc
    2. _TARGET_GenMdlTarget.inc
    3. _TARGET_GenMdlInfo.h

We added five new C++ source files:

1. llvm/include/llvm/CodeGen/MDLBundle.h
2. llvm/include/llvm/MDLHazardRecognizer.h
3. llvm/include/llvm/MC/MDLInstrInfo.h
4. llvm/include/llvm/MC/MDLInfo.h
5. llvm/lib/MC/MDLInstrInfo.cpp

There are a few new dependencies for LLVM:

1. The tdscan step is dependent on the target’s tablegen records.txt files (and on the tdscan utility)
2. The mdl compilation step is dependent on the file produced by tdscan (and on the mdl utility)
3. The Target and MC library sources are dependent on the three files generated by the MDL compiler:
    1. llvm/lib/Target/\*/\*Subtarget.cpp:
        *   #includes _TARGET_GenMdlInfo.inc
        *   #includes _TARGET_GenMdlTarget.inc
    2. llvm/lib/Target/\*/\*MCTargetDesc.cpp
        *   #includes _TARGET_GenMdlInfo.\*
4. New header file dependencies:
    3. MDLInstrInfo.h: used by
        *   lib/CodeGen/TargetSchedule.cpp
        *   lib/MC/MCSchedule.cp
        *   include/llvm/CodeGen/MDLBundle.h
    4. MDLInfo.h: used by
        *   lib/CodeGen/TargetSchedule.cpp
        *   lib/CodeGen/TargetSubtargetInfo.cpp
        *   include/llvm/MC/MdlInstrInfo.h
        *   include/llvm/CodeGen/TargetSubtargetInfo.h
        *   include/LLVM/MC/MCSubtargetInfo.h
    5. MDLBundle.h: used by
        *   lib/CodeGen/MDLBundle.cpp
    6. MDLHazardRecognizer.h: used by
        *   llvm/include/llvm/CodeGen/DFAPacketizer.h
        *   llvm/lib/CodeGen/DFAPacketizer.cpp
        *   llvm/lib/CodeGen/TargetInstrInfo.cpp

